<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Just Call Bud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/lucide-css" rel="stylesheet">
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <h1 class="text-xl font-semibold text-gray-900">JustCallBud.com</h1>
        </div>
    </header>

    <!-- Chat Container -->
    <main class="max-w-4xl mx-auto p-4 flex flex-col">
        <!-- Welcome Section -->
        <div id="messages" class="mb-2 px-4">
            <div class="flex items-start gap-6 py-4 text-gray-500">
                <img src="{{ url_for('static', filename='bud-logo.jpg') }}" alt="Bud Logo" class="w-20 h-20 rounded-full object-cover flex-shrink-0">
                <div class="pt-2">
                    <p class="text-lg font-medium">Hi, I'm Bud. Your AI Handyman. Ask me anything. ðŸ‘‹</p>
                    <p class="text-sm mb-2">Ask me anything about home maintenance and repairs.</p>
                </div>
            </div>
        </div>

        <!-- Ad Space -->
        <div class="bg-white p-2 rounded-lg shadow-sm mb-2">
            <p class="text-gray-400 text-center text-sm">Advertisement Space</p>
        </div>

        <!-- Input Form Area -->
        <div class="sticky bottom-4">
            <!-- Clear Chat Button -->
            <div class="flex justify-end mb-2">
                <button
                    id="clear-chat"
                    type="button"
                    class="text-gray-500 hover:text-gray-700 text-sm flex items-center gap-1 bg-gray-100 px-2 py-1 rounded"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    Clear Chat
                </button>
            </div>

            <!-- Input Form -->
            <form id="chat-form" class="flex gap-2">
                <input
                    type="text"
                    id="message-input"
                    placeholder="Type your question here..."
                    class="flex-1 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                >
                <button
                    type="submit"
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M7 13l-2 2 2 2"></path>
                        <path d="M17 17H7"></path>
                        <path d="M7 3h10l4 4-4 4H7l4-4-4-4z"></path>
                    </svg>
                </button>
            </form>
        </div>
    </main>

    <script>
        const form = document.getElementById('chat-form');
        const input = document.getElementById('message-input');
        const messagesContainer = document.getElementById('messages');

        async function loadMessages() {
            const response = await fetch('/api/messages');
            const messages = await response.json();
            messages.forEach(message => addMessageToUI(message));
        }

        function addMessageToUI(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${message.isUser ? 'justify-end' : 'justify-start'} mb-4`;
            
            const formattedContent = message.content
                .split(/\n\n+/)
                .map(para => `<p class="mb-2 last:mb-0">${para.trim()}</p>`)
                .join('');
            
            messageDiv.innerHTML = `
                <div class="max-w-[85%] rounded-lg px-6 py-4 ${
                    message.isUser
                        ? 'bg-blue-600 text-white'
                        : 'bg-white text-gray-900 border border-gray-100'
                } shadow-sm">
                    ${formattedContent}
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = input.value.trim();
            if (!content) return;

            input.disabled = true;
            form.querySelector('button').disabled = true;

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const botMessage = await response.json();
                
                addMessageToUI({ content, isUser: true });
                input.value = '';
                addMessageToUI(botMessage);

            } catch (error) {
                console.error('Error:', error);
                addMessageToUI({
                    content: "Sorry, there was an error. Please try again.",
                    isUser: false
                });
            } finally {
                input.disabled = false;
                form.querySelector('button').disabled = false;
                input.focus();
            }
        });

        // Add clear chat functionality
        const clearChatButton = document.getElementById('clear-chat');
        
        async function clearChat() {
            try {
                // Clear messages from the server
                await fetch('/api/messages', {
                    method: 'DELETE'
                });
                
                // Clear messages from UI
                messagesContainer.innerHTML = `
                    <div class="flex items-start gap-6 py-4 text-gray-500">
                        <img src="{{ url_for('static', filename='bud-logo.jpg') }}" alt="Bud Logo" class="w-20 h-20 rounded-full object-cover flex-shrink-0">
                        <div class="pt-2">
                            <p class="text-lg font-medium">Hi, I'm Bud. Your AI Handyman. Ask me anything. ðŸ‘‹</p>
                            <p class="text-sm mb-2">Ask me anything about home maintenance and repairs.</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error clearing chat:', error);
            }
        }

        clearChatButton.addEventListener('click', clearChat);

        loadMessages();
    </script>
</body>
</html>